<div class="well-small ">
    <h3 class="topic-header">ALL AGENDAS</h3>
    <div class="sub-topic-header">
        <select name="get_query_type" id="get_query_type" class="dropdown-query">
            <option value="byId">byId</option>
            <option value="bycid">byCid</option>
            <option value="bylinkId">byLinkId</option>
            <option value="byresourcePoolId">byResourcePoolId</option>
            <option value="other">other</option>
        </select>
        <input id="get_query_value" name="get_query_value" class="input-xxlarge" required>
        <label for="get_limit_value" class="sub-topic-header">Limit: </label>
        <input id="get_limit_value" name="get_limit_value" class="input-small" value="20">
        <br/>
        <div>
            TODO: this is performing an AgendaProgress lookup so the query lookup is slightly awkward but we could do byagendaId in javascript if necessary<br>
            <table><td>
            <td><input type="submit" value="Submit Request" name="request_button" onclick="showAgendaStatusList(event);" class="btn btn-primary submit-button"/></td>
            <td align="left">
                <div style="margin-left: 20px;height: 40px;width: 40px">
                    <img id="fission_spinner" src="images/fission.png" class="rotate" style="display: none;">
                </div>
            </td>
            </tr></table>
        </div>
    </div>
</div>

<div id="singleAgendaView">
    <div id="singleAgendaTitle"></div>
    <div id="progressTable" class="table-bordered"></div>
    <a onClick="updateViewState(false);">Return to Agenda List</a>
    <!--TODO  when toggled on the height of the network view ends up super small (aka invisible) so this div needs some tuning... not a fixed height! -->
    <div id="mynetwork" style="overflow: scroll; height: 400px;"></div>
</div>

<div id="agendaStatusView">
    <div id="agendaStatusTable" class="table-bordered"></div>
</div>

<div class="expandable">
    <input id="toggle" type="checkbox" hidden>
    <label for="toggle" class="expand-label">SHOW RESPONSE</label>
    <div id="expand">
        <textarea id="response" name="response" style="width:100%;height:100%;"></textarea>
    </div>
</div>

<script>
function showAgendaStatusList(event){
    var targetServerIndex = $("#target_server").val();
    var server = serverInfo[targetServerIndex];
    var endpoint = endpointsByName["Agenda Progress"];

    toggleSpinner(true);

    processAuthorizedRequest(event,
            server,
            endpoint,
            function(event){
                var queryElement = document.getElementById("get_query_type");
                var querySelectedType = queryElement.options[queryElement.selectedIndex].value;
                var queryValue = getQueryValue("get_query_value");
                var limitValue = getQueryValue("get_limit_value");

                performBasicRequest(
                        "GET",
                        getQueryURL(server, endpoint, querySelectedType, queryValue, limitValue, ""),
                        null,
                        function(response){
                            $("#response").val(JSON.stringify(response, null, 2));
                            buildAgendaStatusTableNew(response);
                            toggleSpinner(false);
                        },
                        function(error){
                            toggleSpinner(false);
                        });
            },
            function(error){
                toggleSpinner(false);
            }
    );
}

function buildAgendaStatusTableNew(response) {
    var tableText = "";
    if(response.errorResponse != null)
    {
        $("#agendaStatusTable").innerHTML = tableText;
        return;
    }
    tableText += "<table class=\"table-bordered\">";
    tableText += "<thead><tr><th>Agenda</th><th>State</th><th>Message</th><th>Attempts Completed</th><th>CID</th></tr></thead>";
    tableText += "<tbody>";
    response["all"].forEach(function (agendaProgress, index) {
        tableText += "<tr>"
                //+ addTd(agendaProgress.agendaId)
                + addTd("<a onClick=\"requestAgendaNodeViewUpdateNew(\'" + agendaProgress.agendaId + "\', \'" + agendaProgress.id + "\');\" style=\"cursor: pointer; cursor:"
                        + " hand;\">" + agendaProgress.agendaId + "</a>")
                + addTd(agendaProgress.processingState)
                + addTd(agendaProgress.processingStateMessage)
                + addTd(defined(agendaProgress.attemptsCompleted) ? agendaProgress.attemptsCompleted : "0")
                + addTd(defined(agendaProgress.cid) ? agendaProgress.cid : "unset")
                + "</tr>";
    });
    tableText += "</tbody></table>";
    $("#agendaStatusTable").html(tableText);
}

function requestAgendaNodeViewUpdateNew(agendaId, agendaProgressId) {
    var targetServerIndex = $("#target_server").val();
    var server = serverInfo[targetServerIndex];
    toggleSpinner(true);
    performRequest(
            "GET",
            getQueryURL(server, endpointsByName["Agenda"], "byid", agendaId, 1, ""),
            null,
            function(response) {
                var agenda = response["all"][0];
                // TODO: would like to do this request at the same time...
                performRequest(
                        "GET",
                        getQueryURL(server, endpointsByName["Agenda Progress"], "byid", agendaProgressId, 1, ""),
                        null,
                        function(response) {
                            var agendaProgress = response["all"][0];
                            setupAgendaNetwork(agenda, agendaProgress);
                            writeSingleAgendaProgressTable(response);
                            switchToSingleAgendaView(agendaId);
                        }
                );
            }
    );
}

function switchToSingleAgendaView(agendaId){
    $("#singleAgendaTitle").html("<p class=\"topic-header\">Agenda</p><p>" + agendaId +"</p>");
    updateViewState(true);
}

function updateViewState(showSingleAgenda){
    $("#singleAgendaView").toggle(showSingleAgenda);
    $("#mynetwork").toggle(showSingleAgenda);
    $("#agendaStatusView").toggle(!showSingleAgenda);
}

updateViewState(false);

</script>